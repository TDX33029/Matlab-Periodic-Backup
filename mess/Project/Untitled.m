
clear; clc; close all;

% ?????? (x, y)
BS = [ -1000,200;
    -462,926;
    0,1800;
    345	,1882;
    1000,1800;
    0,200;];% ??6

% ????TDOA?????
data = csvread('TDOA_RES.csv'); % ??????

% ?????????????????
c = 1; % m/s

% ???????
num_samples = size(data, 1);
positions = zeros(num_samples, 2); % ????????????

for i = 1:num_samples
    tdoa = data(i, :); % ???i?TDOA??
    r = tdoa * c; % ??????????
    
    % ?????????????
    positions(i, :) = solve_tdoa(BS, r);
end

% ????????
figure; hold on;
axis equal;
set(gca,'ylim',[0 2000]);
set(gca,'xlim',[-1000 1000]);
scatter(BS(:,1), BS(:,2), 100, 'r', 'filled'); % ????
scatter(positions(:,1), positions(:,2), 50, 'b', 'x'); % ??????????
xlabel('X (m)'); ylabel('Y (m)');
title('TDOA Localization Result');
legend('Base Stations', 'Estimated Positions');
grid on; axis equal;

% TDOA ??????
function pos = solve_tdoa(BS, r)
    % ??????????
    x0 = mean(BS, 1); % ?????
    options = optimset('Display', 'off');
    pos = lsqnonlin(@(x) tdoa_residual(x, BS, r), x0, [], [], options);
end

function res = tdoa_residual(x, BS, r)
    % ?? TDOA ??
    d = vecnorm(BS - x, 2, 2); % ??????????????
    d_diff = d(2:end) - d(1);  % ?????1????
    res = d_diff - r(:);       % ????
end
